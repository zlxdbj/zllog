# 文件日志规范（JSON 标准版）

## 1. 目的与适用范围

本规范统一系统日志采用 **JSON 格式**进行记录、存储与归档，适用于：
- 后端服务 / 微服务系统
- 应用程序运行日志
- 文件处理、批处理、任务调度日志
- 审计与合规相关日志

目标：
- 结构化、可机器解析
- 便于集中采集、检索与分析
- 满足长期存档与合规审计要求

---

## 2. 日志总体原则

1. **统一格式**：所有日志必须为合法 JSON
2. **一行一条日志**（One Line JSON）
3. **字段稳定**：禁止随意变更或复用字段含义
4. **向后兼容**：允许新增字段，不允许删除/重定义
5. **禁止敏感明文**：必要信息需脱敏

---

## 3. 日志级别规范

| 级别 | 含义 | 使用说明 |
|----|----|----|
| DEBUG | 调试信息 | 仅开发/测试环境开启 |
| INFO | 正常业务行为 | 默认开启 |
| WARN | 潜在问题 | 不影响当前流程 |
| ERROR | 业务或系统错误 | 必须记录异常信息 |
| FATAL | 系统不可用 | 触发告警与人工介入 |

---

## 4. 日志字段规范（核心）

### 4.1 必须字段（Mandatory）

| 字段名 | 类型 | 说明 |
|------|----|----|
| timestamp | string | ISO 8601 时间（含毫秒） |
| level | string | 日志级别 |
| service | string | 系统/服务名称 |
| module | string | 模块/功能点 |
| trace_id | string | 链路追踪 ID |
| message | string | 日志说明 |

### 4.2 推荐字段（Recommended）

| 字段名 | 类型 | 说明 |
|------|----|----|
| host | string | 主机名 / 容器 ID |
| env | string | 环境（dev/test/prod） |
| operator | string | 操作人/进程 |
| request_id | string | 请求唯一标识 |
| cost_ms | number | 执行耗时 |
| result | string | success / fail |

### 4.3 异常字段（ERROR 必须）

| 字段名 | 类型 | 说明 |
|------|----|----|
| error_code | string | 错误码 |
| error_msg | string | 错误信息 |
| stack_trace | string | 异常堆栈（可截断） |

---

## 5. 日志格式示例（标准 JSON）

### 5.1 INFO 示例

```json
{
  "timestamp": "2026-01-13T10:15:30.123+08:00",
  "level": "INFO",
  "service": "order-service",
  "module": "file-upload",
  "trace_id": "a8f23c9e",
  "operator": "user123",
  "result": "success",
  "message": "文件上传成功"
}
```

### 5.2 ERROR 示例

```json
{
  "timestamp": "2026-01-13T10:16:01.456+08:00",
  "level": "ERROR",
  "service": "order-service",
  "module": "file-upload",
  "trace_id": "a8f23c9e",
  "error_code": "UPLOAD_500",
  "error_msg": "文件存储失败",
  "stack_trace": "IOException: disk full",
  "message": "文件上传异常"
}
```

---

## 6. 日志生成规范

### 6.1 生成时机（必须记录）

- 服务启动 / 关闭
- 外部接口调用（开始 / 结束）
- 文件生成、写入、删除
- 关键业务状态变更
- 异常捕获（禁止吞异常）

### 6.2 生成要求

1. **统一日志框架（必须）**

| 语言 | 推荐框架 | 说明 |
|----|----|----|
| Java | Log4j2 / Logback（JSON Encoder） | 成熟、稳定 |
| Python | logging + JSON Formatter | 官方库 |
| Node.js | winston / pino | 高性能 |
| **Go** | **zap / zerolog + lumberjack** | 高性能 JSON 日志 |

2. 禁止：
   - System.out / print / fmt.Println
   - 非 JSON 格式日志

3. 日志必须 **append 方式写入**，禁止覆盖已有日志文件

---

## 7. 日志文件与滚动策略（大小 + 日期双策略）

### 7.1 基本原则

1. **日志只能追加写入（Append Only）**
2. **禁止 truncate / 覆盖历史日志**
3. 滚动后日志文件设为 **只读**

---

### 7.2 文件命名规范

当前日志文件：
```text
{service}.log
```

滚动后日志文件：
```text
{service}-{yyyyMMdd-HHmmss}.log.gz
```

示例：
```text
order-service.log
order-service-20260113-101530.log.gz
```

---

### 7.3 滚动触发策略（双策略）

**任一条件满足即触发滚动：**

1. **大小触发**
   - 单个日志文件达到设定大小（如 100MB）

2. **日期触发**
   - 跨自然日（00:00）即触发
   - 即使文件大小未达到阈值

---

### 7.4 滚动执行规则（强制）

触发滚动时，必须按以下顺序执行：

1. 关闭当前日志文件句柄
2. 将当前日志文件重命名为带时间戳文件
3. **立即压缩（gzip / zstd）**
4. 设置压缩文件为只读
5. 创建新的日志文件继续写入

> ⚠️ 不允许未压缩的历史日志长期存在

---

### 7.5 Go 语言实现建议（说明级）

Go 推荐组合：
- **zap / zerolog**：负责 JSON 日志格式
- **lumberjack**：负责大小 + 日期滚动与压缩

关键能力要求：
- MaxSize（MB）
- 按日期强制切割（可通过外层定时器或封装实现）
- Compress = true
- LocalTime = true

---

## 7. 日志文件与滚动策略

### 7.1 文件命名

```text
{service}-{date}.log
```

示例：
```text
order-service-20260113.log
```

### 7.2 滚动策略

- 按日期滚动（推荐）
- 或按大小滚动（如 100MB）
- 滚动后文件只读

---

## 8. 日志存档规范

### 8.1 目录结构

```text
/logs
  ├── order-service
  │   ├── 2026/01/
  │   │   ├── order-service-20260113.log
```

### 8.2 存档与压缩

- 按月归档
- 使用 gzip / zstd 压缩
- 压缩后文件禁止修改

示例：
```text
order-service-202601.log.gz
```

### 8.3 保留周期

| 日志类型 | 在线 | 归档 |
|--------|----|----|
| INFO/WARN | 3–6 个月 | 1–3 年 |
| ERROR | 6–12 个月 | ≥3 年 |
| 审计日志 | ≥1 年 | 按法规 |

---

## 9. 安全与合规

1. 禁止记录明文敏感信息
2. 必须脱敏：身份证、手机号、账号
3. 审计日志不可删除、不可覆盖
4. 日志访问需权限控制

---

## 10. 日志清理策略

- 定期清理已过期日志
- 清理前确保已归档
- 清理操作本身必须记录日志

---

> 本规范为 JSON 日志统一标准，适用于集中日志平台（ELK / Loki / 云日志）。

